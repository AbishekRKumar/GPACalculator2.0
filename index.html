<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OUSL GPA Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <!-- Canvas Confetti Library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --primary: #FF6B35;
      --secondary: #FF9F1C;
      --background: #FFFFFF;
      --text: #2D3436;
      --accent: #FFEBD6;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      backdrop-filter: blur(10px);
    }
    h1 {
      color: var(--primary);
      margin-bottom: 2rem;
      text-align: center;
      font-size: 2.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    .course {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
      background: var(--accent);
      padding: 1rem;
      border-radius: 12px;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .course input,
    .course select {
      padding: 0.8rem;
      border: 2px solid var(--primary);
      border-radius: 12px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: white;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.2);
    }
    .deleteCourseButton {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.3s ease;
    }
    .deleteCourseButton:hover {
      color: var(--secondary);
    }
    button {
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      justify-content: center;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 1rem;
      border-radius: 12px;
    }
    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    #result {
      margin-top: 2rem;
      padding: 2rem;
      background: var(--accent);
      border-radius: 16px;
      text-align: center;
      display: none;
    }
    .gpa-display {
      font-size: 3rem;
      color: var(--primary);
      font-weight: 800;
      margin: 1rem 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    .actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    .developer-info {
      margin-top: 3rem;
      padding: 1.5rem;
      background: rgba(255, 107, 53, 0.1);
      border-radius: 12px;
      text-align: center;
      border-top: 3px solid var(--primary);
    }
    .disclaimer {
      margin: 1.5rem 0;
      padding: 1rem;
      background: rgba(255, 0, 0, 0.05);
      border: 1px solid #ffcccc;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #666;
    }
    .developer-info p {
      margin: 0.5rem 0;
      color: var(--text);
      font-size: 0.9rem;
    }
    .developer-info a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    .developer-info a:hover {
      text-decoration: underline;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--accent);
      padding: 0.5rem 1rem;
      border-radius: 25px;
      margin: 0.5rem 0;
    }
    @media (max-width: 600px) {
      .course {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 1.5rem;
        border-radius: 16px;
      }
      body {
        padding: 1rem;
      }
      h1 {
        font-size: 2rem;
      }
      .developer-info {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-calculator"></i> OUSL GPA Calculator</h1>

    <form id="gpaForm">
      <div id="coursesContainer">
        <!-- Courses will be added dynamically -->
      </div>
      <div class="actions">
        <button type="button" id="addCourseButton">
          <i class="fas fa-plus-circle"></i> Add Course
        </button>
        <button type="submit" id="calculateButton" disabled>
          <i class="fas fa-calculator"></i> Calculate GPA
        </button>
      </div>
    </form>

    <div id="result">
      <h2>Your Academic Summary</h2>
      <div class="gpa-display"><span id="gpaValue">0.00</span></div>
      <p id="gpaClass" class="gpa-class"></p>
      <!-- New paragraph for a random nice message -->
      <p id="niceMessage"></p>
      <div class="actions">
        <button id="shareButton">
          <i class="fas fa-share-alt"></i> Share Results
        </button>
      </div>
    </div>

    <div class="developer-info">
      <div class="badge">
        <i class="fas fa-user-graduate" style="color: var(--primary);"></i>
        <span>Developer Information</span>
      </div>
      <p>R. Abishek - BSc (Natural Sciences) - Undergraduate</p>
      <p>The Open University of Sri Lanka</p>
      <p>
        <i class="fas fa-envelope"></i> Contact:
        <a href="mailto:abi.kumar6324@gmail.com">abi.kumar6324@gmail.com</a>
      </p>
      <p style="margin-top: 1rem; font-size: 0.8rem;">
        <i class="fas fa-code"></i> Crafted with care for OUSL students
      </p>
    </div>

    <div class="disclaimer">
      <i class="fas fa-info-circle"></i> Note: This is an independent academic tool not affiliated with The Open University of Sri Lanka. Results should be verified with official university resources. For official GPA calculations, please consult your relevant faculty.
    </div>

    <!-- Load Existing Data Button (placed at the bottom) -->
    <div class="actions" style="margin-top: 1rem;">
      <button type="button" id="uploadExcelButton">
        <i class="fas fa-file-upload"></i> Load Existing Data
      </button>
      <input type="file" id="uploadExcelInput" accept=".xlsx, .xls" style="display: none;">
    </div>
  </div>

  <script>
    // Initialize with empty courses container
    document.getElementById('coursesContainer').innerHTML = '';

    function saveCourses() {
      const coursesContainer = document.getElementById('coursesContainer');
      localStorage.setItem('courses', coursesContainer.innerHTML);
      document.getElementById('calculateButton').disabled = coursesContainer.children.length === 0;
    }

    function createCourseElement() {
      const course = document.createElement('div');
      course.className = 'course';
      course.innerHTML = `
        <input type="text" placeholder="Course Name" required>
        <input type="number" placeholder="Credits" min="1" step="0.5" required>
        <select required>
          <option value="4">A+</option>
          <option value="4">A</option>
          <option value="3.7">A-</option>
          <option value="3.3">B+</option>
          <option value="3">B</option>
          <option value="2.7">B-</option>
          <option value="2.3">C+</option>
          <option value="2">C</option>
          <option value="1.7">C-</option>
          <option value="1.3">D+</option>
          <option value="1">D</option>
          <option value="0">E</option>
        </select>
        <button type="button" class="deleteCourseButton" title="Delete Course">
          <i class="fas fa-trash-alt"></i>
        </button>
      `;
      const deleteBtn = course.querySelector('.deleteCourseButton');
      deleteBtn.addEventListener('click', () => {
        course.remove();
        saveCourses();
      });
      return course;
    }

    function addCourseEventListeners() {
      document.querySelectorAll('.course input, .course select').forEach(element => {
        element.addEventListener('change', saveCourses);
      });
    }

    document.getElementById('addCourseButton').addEventListener('click', () => {
      const newCourse = createCourseElement();
      document.getElementById('coursesContainer').appendChild(newCourse);
      addCourseEventListeners();
      saveCourses();
      document.getElementById('calculateButton').disabled = false;
    });

    document.getElementById('gpaForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const courses = document.getElementsByClassName('course');
      let totalCredits = 0;
      let totalPoints = 0;
      const courseData = [];

      Array.from(courses).forEach(course => {
        const inputs = course.querySelectorAll('input, select');
        const courseName = inputs[0].value;
        const credits = parseFloat(inputs[1].value);
        const gradeValue = parseFloat(inputs[2].value);
        const gradeText = inputs[2].options[inputs[2].selectedIndex].text;
        
        if (!isNaN(credits) && !isNaN(gradeValue)) {
          totalCredits += credits;
          totalPoints += credits * gradeValue;
          courseData.push({
            Course: courseName,
            Credits: credits,
            Grade: gradeText
          });
        }
      });

      const gpa = totalCredits > 0 ? (totalPoints / totalCredits) : 0;
      document.getElementById('gpaValue').textContent = gpa.toFixed(2);
      document.getElementById('result').style.display = 'block';

      const gpaClass = document.getElementById('gpaClass');
      if (gpa >= 3.7) gpaClass.textContent = 'First Class Honors';
      else if (gpa >= 3.3) gpaClass.textContent = 'Second Class Upper Division';
      else if (gpa >= 3.0) gpaClass.textContent = 'Second Class Lower Division';
      else gpaClass.textContent = 'General Pass';

      // Set a random encouraging message
      const compliments = [
        "Great job! Keep up the excellent work!",
        "Your dedication is inspiring. Study on!",
        "Outstanding effort! Your hard work is paying off.",
        "Bravo! Your commitment to learning is impressive.",
        "Fantastic work! Keep striving for success.",
        "You're doing amazing! Keep up the momentum."
      ];
      const randomMessage = compliments[Math.floor(Math.random() * compliments.length)];
      document.getElementById('niceMessage').textContent = randomMessage;

      localStorage.setItem('courseData', JSON.stringify(courseData));
      saveCourses();

      // Trigger confetti animation if GPA is more than 3.0
      if (gpa > 3.0) {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
      }
    });

    function generateExcel() {
      const courseData = JSON.parse(localStorage.getItem('courseData') || '[]');
      const gpa = document.getElementById('gpaValue').textContent;
      const gpaClass = document.getElementById('gpaClass').textContent;

      const wsData = [
        ['Course Name', 'Credits', 'Grade'],
        ...courseData.map(c => [c.Course, c.Credits, c.Grade]),
        [],
        ['Final GPA Achieved', gpa],
        ['Academic Classification', gpaClass]
      ];

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'GPA Report');
      return XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    }

    document.getElementById('shareButton').addEventListener('click', () => {
      const data = generateExcel();
      const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const fileName = `OUSL_GPA_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // --- Load Existing Data Feature ---
    document.getElementById('uploadExcelButton').addEventListener('click', () => {
      document.getElementById('uploadExcelInput').click();
    });

    document.getElementById('uploadExcelInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const sheetName = workbook.SheetNames[0]; // use the first sheet
        const worksheet = workbook.Sheets[sheetName];
        const sheetJson = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        // Expecting header row: ["Course Name", "Credits", "Grade"]
        const headers = sheetJson[0];
        if (!headers || headers[0] !== 'Course Name' || headers[1] !== 'Credits' || headers[2] !== 'Grade') {
          alert('Invalid Excel file format.');
          return;
        }
        // Clear current courses
        const coursesContainer = document.getElementById('coursesContainer');
        coursesContainer.innerHTML = '';
        // Mapping from letter grade to numeric value
        const letterToNumeric = {
          "A+": 4,
          "A": 4,
          "A-": 3.7,
          "B+": 3.3,
          "B": 3,
          "B-": 2.7,
          "C+": 2.3,
          "C": 2,
          "C-": 1.7,
          "D+": 1.3,
          "D": 1,
          "E": 0
        };
        // Loop through rows (starting at index 1)
        for (let i = 1; i < sheetJson.length; i++) {
          const row = sheetJson[i];
          if (!row || row.length < 3 || !row[0]) break; // stop at empty row
          const courseName = row[0];
          const credits = parseFloat(row[1]);
          const gradeLetter = row[2];
          // Create a new course element and set its values.
          const course = createCourseElement();
          const inputs = course.querySelectorAll('input, select');
          inputs[0].value = courseName;
          inputs[1].value = credits;
          const select = inputs[2];
          for (let j = 0; j < select.options.length; j++) {
            if (select.options[j].text === gradeLetter) {
              select.selectedIndex = j;
              break;
            }
          }
          coursesContainer.appendChild(course);
        }
        addCourseEventListeners();
        saveCourses();
      };
      reader.readAsBinaryString(file);
    });
  </script>
</body>
</html>
